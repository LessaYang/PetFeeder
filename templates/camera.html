{% extends "layout.html" %}
{% block content %}
<div class="card">
  <h2 class="text-xl font-semibold mb-2">Live Camera</h2>
  <p class="mb-4">
    View your pet in real time. The stream automatically updates when available.
  </p>

  <!-- Stream URL field -->
  <form id="urlForm" class="mb-4">
    <label for="streamUrl" class="block text-sm font-medium mb-1">
      Stream URL (auto-detected, change for ngrok if needed)
    </label>
    <input
      type="text"
      id="streamUrl"
      name="streamUrl"
      class="w-full border border-gray-300 rounded px-2 py-1"
      value="{{ stream_url }}"
    />
  </form>

  <!-- Live Stream Viewer -->
  <div
    class="rounded overflow-hidden border border-gray-400 bg-black flex justify-center items-center"
    style="min-height: 300px;"
  >
    <img
      id="stream"
      src="{{ stream_url }}"
      alt="Camera stream"
      class="w-full h-auto block"
      style="max-height: 480px;"
    />
    <p id="noStream" class="text-gray-400 text-center hidden">
      Stream not available. Make sure your Raspberry Pi camera and mjpg-streamer are running.
    </p>
  </div>

  <!-- Control Buttons -->
  <div class="flex gap-2 mt-4">
    <button type="button" onclick="startCamera()" class="btn">Turn On Camera</button>
    <button type="button" onclick="stopCamera()" class="btn bg-red-500 hover:bg-red-600">
      Turn Off Camera
    </button>
    <button type="button" onclick="reloadStream()" class="btn bg-gray-500 hover:bg-gray-600">
      Reload Stream
    </button>
  </div>
</div>

<script>
const baseApi = "{{ request.host_url }}api";
const streamImg = document.getElementById("stream");
const urlInput = document.getElementById("streamUrl");
const noStreamMsg = document.getElementById("noStream");

let isMobile = /Mobi|Android/i.test(navigator.userAgent);
let mobileInterval = null;

// Fetch latest ngrok URL from backend
async function fetchNgrokUrl() {
  try {
    const res = await fetch(`${baseApi}/get_ngrok`);
    const data = await res.json();
    if (data.url) {
      const streamLink = data.url + "/?action=stream";
      urlInput.value = streamLink;
      if (!isMobile) {
        streamImg.src = streamLink; // desktop uses MJPEG
        noStreamMsg.style.display = "none";
      }
    }
  } catch (err) {
    console.error("Failed to fetch ngrok URL:", err);
  }
}

// Start camera (send command to Pi)
function startCamera() {
  fetch(`${baseApi}/camera/on`, { method: "POST" })
    .then(() => {
      if (isMobile) startMobilePolling();
      else streamImg.src = urlInput.value.trim();
      noStreamMsg.style.display = "none";
      alert("Camera turned ON");
    })
    .catch(err => console.error("Failed to start camera:", err));
}

// Stop camera
function stopCamera() {
  fetch(`${baseApi}/camera/off`, { method: "POST" })
    .then(() => {
      if (isMobile) stopMobilePolling();
      streamImg.src = "";
      noStreamMsg.style.display = "block";
      alert("Camera turned OFF");
    })
    .catch(err => console.error("Failed to stop camera:", err));
}

// Reload stream manually
function reloadStream() {
  const url = urlInput.value.trim();
  if (!url) return;
  streamImg.src = url + "&t=" + new Date().getTime(); // force reload
  noStreamMsg.style.display = "none";
}

// Mobile polling for latest.jpg
function startMobilePolling() {
  if (mobileInterval) return;
  mobileInterval = setInterval(() => {
    const url = urlInput.value.replace(/\/\?action=stream$/, '/latest.jpg');
    streamImg.src = url + "?t=" + new Date().getTime();
    noStreamMsg.style.display = "none";
  }, 500);
}

function stopMobilePolling() {
  if (mobileInterval) clearInterval(mobileInterval);
  mobileInterval = null;
}

// Auto-refresh ngrok URL every 30s
fetchNgrokUrl();
setInterval(fetchNgrokUrl, 30000);
</script>
{% endblock %}
