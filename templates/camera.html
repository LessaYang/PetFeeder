{% extends "layout.html" %}
{% block content %}
<div class="card">
  <h2 class="text-xl font-semibold mb-2">Live Camera</h2>
  <p class="mb-4">
    View your pet in real time. The stream automatically updates when available.
  </p>

  <!-- Stream URL field -->
  <form id="urlForm" class="mb-4">
    <label for="streamUrl" class="block text-sm font-medium mb-1">
      Stream URL (auto-detected, change for ngrok if needed)
    </label>
    <input
      type="text"
      id="streamUrl"
      name="streamUrl"
      class="w-full border border-gray-300 rounded px-2 py-1"
      value="{{ stream_url }}"
    />
  </form>

  <!-- Live Stream Viewer -->
  <div
    class="rounded overflow-hidden border border-gray-400 bg-black flex justify-center items-center"
    style="min-height: 300px;"
  >
    <!-- Use video for MJPEG streaming to support mobile -->
    <video
      id="streamVideo"
      autoplay
      playsinline
      muted
      class="w-full h-auto block"
      style="max-height: 480px;"
      onerror="document.getElementById('noStream').style.display='block';"
    >
      <source src="{{ stream_url }}/?action=stream" type="multipart/x-mixed-replace" />
    </video>

    <p id="noStream" class="text-gray-400 text-center hidden">
      Stream not available. Make sure your Raspberry Pi camera and mjpg-streamer are running.
    </p>
  </div>

  <!-- Control Buttons -->
  <div class="flex gap-2 mt-4">
    <button type="button" onclick="startCamera()" class="btn">Turn On Camera</button>
    <button type="button" onclick="stopCamera()" class="btn bg-red-500 hover:bg-red-600">
      Turn Off Camera
    </button>
    <button type="button" onclick="reloadStream()" class="btn bg-gray-500 hover:bg-gray-600">
      Reload Stream
    </button>
  </div>
</div>

<script>
  const baseApi = "{{ request.host_url }}api";
  const streamVideo = document.getElementById("streamVideo");
  const urlInput = document.getElementById("streamUrl");
  const noStreamMsg = document.getElementById("noStream");

  async function fetchNgrokUrl() {
    try {
      const res = await fetch(`${baseApi}/get_ngrok`);
      const data = await res.json();
      if (data.url) {
        const streamLink = data.url + "/?action=stream";
        streamVideo.querySelector("source").src = streamLink;
        streamVideo.load(); // reload video
        urlInput.value = streamLink;
        noStreamMsg.style.display = "none";
      }
    } catch (err) {
      console.error("Failed to fetch ngrok URL:", err);
    }
  }

  function startCamera() {
    fetch(`${baseApi}/camera/on`, { method: "POST" })
      .then(() => {
        streamVideo.src = urlInput.value.trim();
        streamVideo.load();
        noStreamMsg.style.display = "none";
        alert("Camera turned ON");
      })
      .catch(err => console.error("Failed to start camera:", err));
  }

  function stopCamera() {
    fetch(`${baseApi}/camera/off`, { method: "POST" })
      .then(() => {
        streamVideo.pause();
        noStreamMsg.style.display = "block";
        alert("Camera turned OFF");
      })
      .catch(err => console.error("Failed to stop camera:", err));
  }

  function reloadStream() {
    const url = urlInput.value.trim();
    if (!url) return;
    streamVideo.querySelector("source").src = url + "&t=" + new Date().getTime();
    streamVideo.load();
    noStreamMsg.style.display = "none";
  }

  // Auto-refresh ngrok link every 30 seconds
  fetchNgrokUrl();
  setInterval(fetchNgrokUrl, 30000);
</script>
{% endblock %}
