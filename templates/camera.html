{% extends "layout.html" %}
{% block content %}
<div class="card">
  <h2 class="text-xl font-semibold mb-2">Live Camera</h2>
  <p class="mb-4">
    View your pet in real time. The stream automatically updates every second.
  </p>

  <!-- Stream URL field (auto-filled from Flask) -->
  <form id="urlForm" class="mb-4">
    <label for="streamUrl" class="block text-sm font-medium mb-1">
      Stream Base URL (auto-detected, change if needed)
    </label>
    <input
      type="text"
      id="streamUrl"
      name="streamUrl"
      class="w-full border border-gray-300 rounded px-2 py-1"
      value="{{ stream_url }}"
    />
  </form>

  <!-- Live Stream Viewer -->
  <div
    class="rounded overflow-hidden border border-gray-400 bg-black flex justify-center items-center"
    style="min-height: 300px;"
  >
    <img
      id="stream"
      src="{{ stream_url }}/latest.jpg"
      alt="Camera stream"
      class="w-full h-auto block"
      style="max-height: 480px;"
      onerror="this.onerror=null;this.src='';document.getElementById('noStream').style.display='block';"
    />
    <p id="noStream" class="text-gray-400 text-center hidden">
      Stream not available. Make sure your Raspberry Pi camera is running.
    </p>
  </div>

  <!-- Control Buttons -->
  <div class="flex gap-2 mt-4">
    <button type="button" onclick="startCamera()" class="btn">Turn On Camera</button>
    <button type="button" onclick="stopCamera()" class="btn bg-red-500 hover:bg-red-600">
      Turn Off Camera
    </button>
    <button type="button" onclick="reloadStream()" class="btn bg-gray-500 hover:bg-gray-600">
      Reload Stream
    </button>
  </div>
</div>

<script>
  const baseApi = "{{ request.host_url }}api";
  const streamImg = document.getElementById("stream");
  const urlInput = document.getElementById("streamUrl");
  const noStreamMsg = document.getElementById("noStream");

  function updateStream() {
    const url = urlInput.value.trim();
    if (!url) return;
    streamImg.src = url + "/latest.jpg?t=" + new Date().getTime(); // force reload
    noStreamMsg.style.display = "none";
  }

  // Auto-refresh every 1 second for live feed
  setInterval(updateStream, 1000);

  async function fetchNgrokUrl() {
    try {
      const res = await fetch(`${baseApi}/get_ngrok`);
      const data = await res.json();
      if (data.url) {
        const baseUrl = data.url;
        urlInput.value = baseUrl;
        updateStream();
      }
    } catch (err) {
      console.error("Failed to fetch ngrok URL:", err);
    }
  }

  function startCamera() {
    fetch(`${baseApi}/camera/on`, { method: "POST" })
      .then(() => {
        updateStream();
        alert("Camera turned ON");
      })
      .catch(err => console.error("Failed to start camera:", err));
  }

  function stopCamera() {
    fetch(`${baseApi}/camera/off`, { method: "POST" })
      .then(() => {
        streamImg.src = "";
        noStreamMsg.style.display = "block";
        alert("Camera turned OFF");
      })
      .catch(err => console.error("Failed to stop camera:", err));
  }

  function reloadStream() {
    updateStream();
  }

  // Initial fetch of ngrok URL if available
  fetchNgrokUrl();
  setInterval(fetchNgrokUrl, 30000); // refresh ngrok URL every 30s
</script>
{% endblock %}
